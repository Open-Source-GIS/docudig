{% extends "base.html" %}
{% block title %}{% if about %}Diary Dig{% else %}Search{% endif %}{% endblock %}
{% block content %}

<div class='sidebar'>
    {% include "afg/_logo.html" %}
    <script type='text/javascript'>
        function clean_get(form) {
            var inputs = $(form).find("input");
            inputs.each(function() {
                var el = $(this);
                var val = $(this).val();
                if (val === '' || (val === '0' && /.*gte/.test(el.name))) {
                    $(this).remove();
                }
            });
            return true;
        }
    </script>
    <form method='get' action='{% url afg.search %}' onsubmit='return clean_get(this);'>
        <input type='text' value='{{ params.q }}' name='q' />
        <input type='submit' value='search' />

    {% for param, choice_opts in choices.items %}
    <h2>{{ choice_opts.title }}</h2>
    {% if choice_opts.value %}
        <input type='hidden' name='{{ param }}' value='{{ choice_opts.value }}' />
    {% endif %}
    <ul>
        {% for choice in choice_opts.choices %}
        <li>
            {% if choice_opts.choices|length > 1 %}
                <a href="{{ qstring }}&{{ param }}={{choice.1}}">{% firstof choice.0 "None" %}</a> ({{ choice.2 }})
            {% else %}
                {% firstof choice.0 "None" %} ({{ choice.2 }})
            {% endif %}
        </li>
        {% endfor %}
    </ul>
    {% endfor %}

    {% for param, choice_opts in min_max_choices.items %}
    <h2>{{ choice_opts.title }}</h2>
    <div id='sparkline_{{param}}'></div>
    <div id='slider_{{param}}'></div>
    <div>
        <div style='float: left;'>
            <input name='{{param}}__gte' id='{{param}}__gte' value='{{ choice_opts.chosen_min }}' size=3 />
            (min: {{ choice_opts.min_value }})
        </div>
        <div style='float: right;'>
            (max: {{ choice_opts.max_value }})
            <input name='{{param}}__lte' id='{{param}}__lte' value='{{ choice_opts.chosen_max }}' size=3 />
        </div>
        <div style='clear: both;'></div>
    </div>
    <script type='text/javascript'>
        var vals = [{{choice_opts.counts|join:", "}}];
        // remove '0' which out-ranges all other values
        vals.splice(0, 1);
        $('#sparkline_{{param}}').sparkline(vals, {width: '100%'});
        var update = function(event, ui) {
            var val = $(this).slider('option', 'values');
            $("#{{param}}__gte").val(val[0]);
            $("#{{param}}__lte").val(val[1]);
        }
        $('#slider_{{param}}').slider({
            range: true,
            values: [{% if choice_opts.chosen_min %} {{ choice_opts.chosen_min }}{% else %}{{ choice_opts.min_value }}{% endif %}, 
                     {% if choice_opts.chosen_max %} {{ choice_opts.chosen_max }}{% else %}{{ choice_opts.max_value }}{% endif %}],
            max: {{ choice_opts.max_value }}, 
            min: {{ choice_opts.min_value }},
            change: update,
            slide: update
        });
    </script>
    {% endfor %}
    <p style='text-align: center;'>
        <input type='submit' value='Search' />
    </p>
    </form>
    <hr>
    <ul>
        <li><a href='{% url afg.random_entry %}'>Random entry</a></li>
    </ul>
    <br />
</div>
<div class='results'>
    <div class='constraints'>
        Searching for: 
        {% if not constraints %}
            {% if about %}
                Truth
            {% else %}
                everything
            {% endif %}
        {% endif %}
        {% for param, value in constraints.items %}
        <span class='constraint'>{{ value.title }}: {{ value.value }} <a href='{{ value.removelink }}'>(X)</a></span>
        {% endfor %}
        {% if not about %}
            <div class='sort'>Sort by:
                <a href='{{ sort.date }}' class='sortdir'>{% if sort.date_asc %}&uarr;{% else %}{% if sort.date_desc %}&darr;{% endif %}{% endif %}</a>
                <a href='{{ sort.date }}'>Date</a> 
                | 
                <a href='{{ sort.total_casualties }}' class='sortdir'>{% if sort.total_casualties_asc %}&uarr;{% else %}{% if sort.total_casualties_desc %}&darr;{% endif %}{% endif %}</a>
                <a href='{{ sort.total_casualties }}'>Casualties</a>
            </div>
        {% endif %}
    </div>
    {% if about %}
        {% include "about.html" %}
    {% else %}{% if entries %}
        {% include "_pagination.html" %}
        <hr>
        {% include "afg/entry_table.html" %}
        <hr>
        {% include "_pagination.html" %}
    {% else %}
        No results.
    {% endif %}{% endif %}
</div>
{% endblock %}
